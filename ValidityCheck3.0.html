<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ValidityCheck</title>
  <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCFZAgbSqsjwm7djtNjwj2IKBoy2_hfPq4",
    authDomain: "validitycheck.firebaseapp.com",
    databaseURL: "https://validitycheck-default-rtdb.firebaseio.com", // <- ESSENCIAL!
    projectId: "validitycheck",
    storageBucket: "validitycheck.firebasestorage.app",
    messagingSenderId: "668951313919",
    appId: "1:668951313919:web:3257270720090440d17bca"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  function testarFirebase() {
    db.ref("testeFirebase").set({
      nome: "Romilson",
      horario: new Date().toLocaleString()
    })
    .then(() => {
      alert("Dados salvos com sucesso!");
    })
    .catch((erro) => {
      alert("Erro ao salvar: " + erro.message);
    });
  }

  testarFirebase();
</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Estilos gerais e de transição */
    body { 
      font-family: Arial, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #f5f5f5; 
      transition: background 0.5s ease; 
    }
    header {
      background: #222;
      color: white;
      padding: 10px;
      text-align: center;
      font-size: 24px;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1000;
      animation: slideDown 0.5s ease;
    }
    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .tabs {
      display: flex;
      justify-content: space-around;
      background: #333;
      position: fixed;
      top: 52px;
      width: 100%;
      z-index: 999;
      animation: fadeIn 1s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .tab { 
      flex: 1; 
      padding: 10px; 
      color: white; 
      text-align: center; 
      cursor: pointer; 
      transition: background 0.3s ease; 
    }
    .tab:hover { background: #444; }
    .tab.active { background: #555; }
.screen {
  display: none;
  padding: 20px;
  padding-top: 130px;
  animation: fadeInScreen 0.5s ease;
}
    @keyframes fadeInScreen {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .screen.active { display: block; }
    input, textarea, select { 
      width: 100%; 
      padding: 10px; 
      margin-bottom: 10px; 
      transition: background 0.3s ease;
    }
    button { 
      padding: 10px 20px; 
      background: #28a745; 
      color: white; 
      border: none; 
      cursor: pointer; 
      transition: background 0.3s ease; 
    }
    button:hover { background: #218838; }
    /* Animação de pulse para botão */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .pulse {
      animation: pulse 0.5s ease;
    }
    /* Estilo e animação para os cards de produto */
    .product-card { 
      background: white; 
      margin: 10px 0; 
      padding: 10px; 
      /* Faixa verde padrão para produto que não está próximo do vencimento */
      border-left: 5px solid #28a745; 
      position: relative; 
      transition: transform 0.3s ease; 
      animation: fadeInCard 0.5s ease forwards;
    }
    .product-card:hover { transform: scale(1.02); }
    /* Quando o produto está próximo do vencimento, a classe 'soon' deixa a faixa vermelha */
    .product-card.soon { border-color: red; }
    @keyframes fadeInCard {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .product-card .delete-btn { 
      position: absolute; 
      top: 10px; 
      right: 10px; 
      background: red; 
      color: white; 
      border: none; 
      padding: 5px; 
      cursor: pointer; 
    }
    /* Estilos para o calendário */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 10px;
      position: sticky;
      top: 105px;
      background: #f5f5f5;
      z-index: 998;
      padding-bottom: 10px;
    }
    .day { 
      background: #ddd; 
      padding: 10px; 
      text-align: center; 
      cursor: pointer; 
      transition: background 0.3s ease; 
    }
    .day:hover { background: #ccc; }
    .day.empty { background: #f0f0f0; color: #aaa; cursor: default; }
    .day.has-product { 
      background: orange; 
      animation: pulseBorder 1s infinite alternate;
    }
    @keyframes pulseBorder {
      from { box-shadow: 0 0 5px orange; }
      to { box-shadow: 0 0 20px orange; }
    }
    .nav-month {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      position: sticky;
      top: 85px;
      background: #f5f5f5;
      z-index: 998;
      padding-bottom: 5px;
    }
    .pdf-button { 
      margin-top: 10px; 
      background: #007bff; 
    }
    /* Estilo para o popup de confirmação */
    #popup {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 15px 20px;
      border-radius: 5px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease, transform 0.5s ease;
      transform: translateY(-20px);
      z-index: 2000;
    }
    #popup.show {
      opacity: 1;
      transform: translateY(0);
    }
    .modal.hidden {
  display: none;
}
.modal {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999;
}
.modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
}
.close {
  float: right;
  cursor: pointer;
}
.card-historico {
  border: 1px solid #ccc;
  border-radius: 8px;
  margin: 10px 0;
  padding: 10px;
  box-shadow: 2px 2px 6px rgba(0,0,0,0.1);
  background: white;
  position: relative;
  overflow: hidden;
}

.card-historico .tag-top {
  height: 8px;
  width: 100%;
  position: absolute;
  top: 0;
  left: 0;
}

.tag-vencido   { background: #e74c3c; } /* Vermelho (mantido) */
.tag-editado   { background: #3498db; } /* Azul */
.tag-excluído  { background: #7f8c8d; } /* Cinza escuro */

.card-historico small {
  display: block;
  color: #666;
  margin-bottom: 5px;
}
  /* Novo estilo para o formulário de Adicionar Produto */
  #add input, 
  #add textarea, 
  #add select {
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 12px 15px;
    margin-bottom: 15px;
    font-size: 16px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    transition: border-color 0.3s, box-shadow 0.3s;
  }

  #add input:focus, 
  #add textarea:focus, 
  #add select:focus {
    border-color: #007bff;
    box-shadow: 0 0 8px rgba(0,123,255,0.2);
    outline: none;
  }

  #add textarea {
    resize: vertical;
    min-height: 100px;
  }

  #add {
    max-width: 500px;
    margin: 0 auto;
    padding-top: 30px;
  }
  #add {
  margin-top: 100px; /* ou ajusta para 120px se precisar */
}
.analytics-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  padding: 8px 12px;
  background-color: #f9f9f9;
  border-bottom: 2px solid #ccc;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  font-size: 13px;
  color: #333;
  justify-content: start;
  align-items: center;
  overflow-x: auto;
}

.analytics-bar span {
  background-color: #e0e0e0;
  padding: 4px 8px;
  border-radius: 6px;
  font-weight: 600;
  white-space: nowrap;
}
  </style>
</head>
<body>
<header>ValidityCheck</header>
<div class="tabs">
  <div class="tab active" onclick="showTab('add', event)">Adicionar Produto</div>
  <div class="tab" onclick="showTab('list', event)">Lista de Produtos</div>
  <div class="tab" onclick="showTab('calendar', event)">Quadro de Vencimentos</div>
  <div class="tab" onclick="showTab('history', event)">Histórico</div>
</div>

<!-- Popup de confirmação -->
<div id="popup"></div>

<div id="add" class="screen active">
  <input id="name" placeholder="Nome do Produto" />
  <input id="date" type="date" />
  <input id="quantity" type="number" min="1" max="999" placeholder="Quantidade" />
  <select id="category"></select>
  <textarea id="info" placeholder="Informações Adicionais"></textarea>
  <button onclick="addProduct(event)">Salvar</button>
</div>
<div id="list" class="screen">
  <select id="filterCategory" onchange="renderList()"></select>
</div>
<div id="calendar" class="screen">
	<!-- Barra Analítico -->
<div id="analyticsBar" class="analytics-bar"></div>
  <div class="nav-month">
    <button onclick="changeMonth(-1)">← Mês Anterior</button>
    <div id="currentMonth"></div>
    <button onclick="changeMonth(1)">Próximo Mês →</button>
  </div>
  <div class="calendar" id="calendarDays"></div>
  <div id="dayProducts"></div>
</div>
<div id="modal" class="modal hidden">
  <div class="modal-content">
    <span onclick="closeModal()" class="close">&times;</span>
    <p id="modal-text">Tem certeza que deseja excluir?</p>
    <button onclick="confirmDelete()">Sim</button>
    <button onclick="closeModal()">Cancelar</button>
  </div>
</div>
<div id="history" class="screen">
  <div id="historyList"></div>
  <button onclick="clearHistory()" class="delete-button">Excluir Histórico</button>
</div>
<script>
	let editId = null;
  // Variáveis e armazenamento
  let products = [];

firebase.database().ref("products").on("value", (snapshot) => {
  const data = snapshot.val();
  products = data ? Object.values(data) : [];
  renderList();
  renderCalendar();
});
  let history = JSON.parse(localStorage.getItem("history") || "[]");
  let selectedCategory = localStorage.getItem("selectedCategory") || "Adega";
  let currentDate = new Date();

  const categorias = [
    "Adega","Azeite/Óleo","Bazar","Bebidas","Biscoitos","Café","Cereais","Chocolates",
    "Condimentos","Doces","Enlatados","Geladeira","Ilhas","Importados","Leites",
    "Light Diet","Limpeza","Macarroes","Outros","Ovos","Pães","Pet","Rações",
    "Refrigerantes","Salgadinhos","Sucos","Variados","Vinhos","Whey"
  ];

  function showPopup(message, color = "#28a745") {
    const popup = document.getElementById("popup");
    popup.textContent = message;
    popup.style.background = color;
    popup.classList.add("show");
    setTimeout(() => {
      popup.classList.remove("show");
    }, 2000);
  }

  function popularCategorias() {
    const catSelect = document.getElementById("category");
    const filterSelect = document.getElementById("filterCategory");
    catSelect.innerHTML = "";
    filterSelect.innerHTML = '<option value="Todas">Todas</option>';
    categorias.forEach(cat => {
      const opt1 = document.createElement("option");
      opt1.value = cat;
      opt1.textContent = cat;
      catSelect.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = cat;
      opt2.textContent = cat;
      filterSelect.appendChild(opt2);
    });
    catSelect.value = selectedCategory;
    filterSelect.value = "Todas";
  }

  function saveProducts() {
  const updates = {};
  products.forEach(p => {
    updates[p.id] = p;
  });
  db.ref("products").set(updates);
}

  // Função para troca de abas com animação
  function showTab(id, event) {
    document.querySelectorAll(".screen").forEach(el => el.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(el => el.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    event.target.classList.add("active");
    if (id === "list") renderList();
    if (id === "calendar") renderCalendar();
    if (id === "history") renderHistory();
  }

  // Função para adicionar produto com animação de pulse no botão
  function addProduct(e) {
  const btn = e.target;
  btn.classList.add("pulse");
  setTimeout(() => { btn.classList.remove("pulse"); }, 500);

  const name = document.getElementById("name").value.trim();
  const date = document.getElementById("date").value;
  const quantity = document.getElementById("quantity").value;
  const info = document.getElementById("info").value;
  const category = document.getElementById("category").value;
  selectedCategory = category;
  localStorage.setItem("selectedCategory", selectedCategory);

  if (!name || !date || !quantity || !category) {
    showPopup("Preencha os campos obrigatórios.", "red");
    return;
  }

  const expiry = new Date(date + 'T00:00:00');
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  if (expiry < today) {
    showPopup("Data de vencimento inválida.", "red");
    return;
  }

  if (editId) {
    // Modo de edição
    const index = products.findIndex(p => p.id === editId);
    if (index !== -1) {
      products[index] = {
        id: editId,
        name,
        date,
        quantity,
        info,
        category
      };
      showPopup("Produto atualizado!");
    }
   history.push({
      tipo: "editado",
      alteradoEm: new Date().toISOString(),
      original: products[index]
    }); 
    editId = null; // Sai do modo de edição
  } else {
    // Novo produto
    products.push({ id: Date.now(), name, date, quantity, info, category });
    showPopup("Produto salvo!");
  }

  saveProducts();
  document.getElementById("name").value = "";
  document.getElementById("date").value = "";
  document.getElementById("quantity").value = "";
  document.getElementById("info").value = "";
  document.getElementById("category").value = selectedCategory;

  renderList();
  renderCalendar();
  checkForNotifications();
}

  let deleteId = null;

function openModal(id) {
  deleteId = id;
  document.getElementById("modal").classList.remove("hidden");
}

function closeModal() {
  deleteId = null;
  document.getElementById("modal").classList.add("hidden");
}

function confirmDelete() {
  if (deleteId !== null) {
    deleteProduct(deleteId);
    closeModal();
  }
  function deleteProduct(id) {
  const deleted = products.find(p => p.id === id);
  if (deleted) {
    history.push({
      tipo: "excluído",
      alteradoEm: new Date().toISOString(),
      original: deleted
    });
  }
  products = products.filter(p => p.id !== id);
  saveProducts();
  renderList();
  renderCalendar();
  showPopup("Produto excluído!", "red");
}
}

  function renderList() {
    const list = document.getElementById("list");
    const filter = document.getElementById("filterCategory").value;
    const filtered = filter === "Todas" ? products : products.filter(p => p.category === filter);

    // Mantém o seletor de filtro e adiciona os produtos
    list.innerHTML = document.

getElementById("filterCategory").outerHTML;
    const sorted = [...filtered].sort((a,b) => new Date(a.date + 'T00:00:00') - new Date(b.date + 'T00:00:00'));
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    sorted.forEach(p => {
      // Calcula quantos dias faltam para o vencimento
      // Remove produtos vencidos automaticamente
const today = new Date();
today.setHours(0, 0, 0, 0);
products = products.filter(p => {
  const vencimento = new Date(p.date + 'T00:00:00');
  if (vencimento < today) {
    history.push({
      tipo: "vencido",
      alteradoEm: new Date().toISOString(),
      original: p
    });
    return false;
  }
  return true;
});
saveProducts();
      const daysLeft = (new Date(p.date + 'T00:00:00') - today) / (1000 * 60 * 60 * 24);
      // Se estiver próximo do vencimento (<= 3 dias), adiciona a classe "soon" para faixa vermelha, caso contrário utiliza a faixa verde padrão.
      const div = document.createElement("div");
      div.className = "product-card" + (daysLeft <= 3 ? " soon" : "");
      div.innerHTML = `
  <strong>${p.name}</strong><br>
  Categoria: ${p.category}<br>
  Vence em ${new Date(p.date + 'T00:00:00').toLocaleDateString()}<br>
  Unidades: ${p.quantity}<br>
  ${p.info ? `<em>Informações: ${p.info}</em><br>` : ""}
  <button onclick="editProduct(${p.id})">Editar</button>
  <button onclick="openModal(${p.id})">Excluir</button>
`;
      list.appendChild(div);
    });
  }
  function editProduct(id) {
  const product = products.find(p => p.id === id);
  if (!product) return;

  editId = id; // Entra em modo de edição

  // Preenche os campos com os dados do produto
  document.getElementById("name").value = product.name;
  document.getElementById("date").value = product.date;
  document.getElementById("quantity").value = product.quantity;
  document.getElementById("info").value = product.info;
  document.getElementById("category").value = product.category;

  // Vai pra aba de adicionar
  document.querySelectorAll(".tab").forEach(el => el.classList.remove("active"));
  document.querySelectorAll(".screen").forEach(el => el.classList.remove("active"));
  document.querySelector(".tab[onclick*='add']").classList.add("active");
  document.getElementById("add").classList.add("active");

  showPopup("Editando produto...", "#007bff");
}

  function renderCalendar() {
    const cal = document.getElementById("calendarDays");
    const label = document.getElementById("currentMonth");
    const dayProducts = document.getElementById("dayProducts");
    cal.innerHTML = "";
    dayProducts.innerHTML = "";

    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    label.textContent = currentDate.toLocaleDateString("pt-BR", { month: 'long', year: 'numeric' });

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month+1, 0).getDate();

    // Cria células vazias para alinhar o primeiro dia da semana
    for (let i = 0; i < firstDay; i++) {
      const empty = document.createElement("div");
      empty.className = "day empty";
      cal.appendChild(empty);
    }

    // Cria os dias do mês e destaca os que possuem produtos
    for (let d = 1; d <= daysInMonth; d++) {
      const dateStr = new Date(year, month, d).toISOString().split("T")[0];
      const hasProducts = products.some(p => p.date === dateStr);
      const day = document.createElement("div");
      day.className = "day" + (hasProducts ? " has-product" : "");
      day.textContent = d;
      if (hasProducts) {
        day.onclick = () => showProductsOfDate(dateStr);
      }
      cal.appendChild(day);
    }
    updateAnalyticsBar();
  }

  function showProductsOfDate(dateStr) {
    const filtered = products.filter(p => p.date === dateStr);
    const cont = document.getElementById("dayProducts");
    cont.innerHTML = `<h3>Produtos para ${new Date(dateStr + 'T00:00:00').toLocaleDateString()}</h3>`;
    filtered.forEach(p => {
  const daysLeft = (new Date(p.date + 'T00:00:00') - new Date()) / (1000 * 60 * 60 * 24);
  const div = document.createElement("div");
  div.className = "product-card" + (daysLeft <= 3 ? " soon" : "");
  div.innerHTML = `
    <strong>${p.name}</strong><br>
    Categoria: ${p.category}<br>
    Unidades: ${p.quantity}<br>
    Vencimento: ${new Date(p.date + 'T00:00:00').toLocaleDateString()}<br>
    ${p.info ? `<em>${p.info}</em><br>` : ""}
  `;
  cont.appendChild(div);
});
    if (filtered.length > 0) {
      const btn = document.createElement("button");
      btn.className = "pdf-button";
      btn.textContent = "Gerar PDF";
      btn.onclick = () => generatePDF(filtered, dateStr);
      cont.appendChild(btn);
    } else {
      cont.innerHTML += "<p>Nenhum produto vence neste dia.</p>";
    }
  }

  function generatePDF(data, dateStr) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text("Relatório de Produtos - " + new Date(dateStr + 'T00:00:00').toLocaleDateString("pt-BR"), 10, 20);

    const headers = [["Produto", "Categoria", "Quantidade", "Vencimento", "Informações"]];
    const rows = data.map(p => [
      p.name,
      p.category,
      p.quantity,
      new Date(p.date + 'T00:00:00').toLocaleDateString("pt-BR"),
      p.info || "-"
    ]);

    doc.autoTable({
      head: headers,
      body: rows,
      startY: 30
    });

    doc.save("produtos_" + dateStr + ".pdf");
  }

  function changeMonth(delta) {
    currentDate.setMonth(currentDate.getMonth() + delta);
    renderCalendar();
  }

  function checkForNotifications() {
    if (!("Notification" in window)) return;
    if (Notification.permission !== "granted") {
      Notification.requestPermission();
    } else {
      const todayStr = new Date().toISOString().split("T")[0];
      const todayProducts = products.filter(p => p.date === todayStr);
      if (todayProducts.length) {
        todayProducts.forEach(p => {
          new Notification("Vencimento Hoje!", {
            body: `${p.name} vence hoje!`,
            icon: "https://cdn-icons-png.flaticon.com/512/3039/3039434.png"
          });
        });
      }
    }
  }

  // Inicialização
  popularCategorias();
  renderCalendar();
  checkForNotifications();
  function renderHistory() {
  const container = document.getElementById("history");
  container.innerHTML = "<h3>Histórico de alterações</h3>";

  const filtered = history
    .filter(item => {
      const data = new Date(item.alteradoEm);
      const diff = (new Date() - data) / (1000 * 60 * 60 * 24);
      return diff <= 30; // apenas últimos 30 dias
    })
    .sort((a, b) => new Date(b.alteradoEm) - new Date(a.alteradoEm)); // ordem decrescente por data

  if (filtered.length === 0) {
    container.innerHTML += "<p>Nenhum histórico recente.</p>";
    return;
  }

  filtered.forEach(item => {
    const card = document.createElement("div");
    card.className = "card-historico";

    const faixa = document.createElement("div");
    faixa.className = "tag-top tag-" + item.tipo;
    card.appendChild(faixa);

    const dataAlt = new Date(item.alteradoEm).toLocaleDateString("pt-BR");
    card.innerHTML += `
      <small>Tipo: ${item.tipo.toUpperCase()}</small>
      <strong>${item.original.name}</strong><br>
      Categoria: ${item.original.category}<br>
      Vencimento: ${new Date(item.original.date + 'T00:00:00').toLocaleDateString("pt-BR")}<br>
      Unidades: ${item.original.quantity}<br>
      ${item.original.info ? `Info: <em>${item.original.info}</em><br>` : ""}
      <small>Alterado em: ${dataAlt}</small>
      <button onclick="deleteHistoryItem('${item.alteradoEm}', '${item.original.name}')">Excluir</button>
    `;
    container.appendChild(card);
  });

  const btnClear = document.createElement("button");
  btnClear.textContent = "Excluir Histórico";
  btnClear.onclick = () => {
    if (confirm("Deseja apagar todo o histórico?")) {
      history = [];
      saveProducts();
      renderHistory();
    }
  };
  container.appendChild(btnClear);
}
function deleteFromHistory(date) {
  history = history.filter(h => h.alteradoEm !== date);
  saveProducts();
  renderHistory();
}

function clearHistory() {
  if (confirm("Tem certeza que deseja excluir todo o histórico?")) {
    history = [];
    saveProducts();
    renderHistory();
  }
}
function isExpiringSoon(validade) {
  const hoje = new Date();
  const dataValidade = new Date(validade);
  const diffTempo = dataValidade - hoje;
  const diffDias = Math.ceil(diffTempo / (1000 * 60 * 60 * 24));
  return diffDias >= 0 && diffDias <= 3;
}
function deleteHistoryItem(data, nome) {
  if (confirm(`Deseja excluir "${nome}" do histórico?`)) {
    history = history.filter(h => h.alteradoEm !== data);
    saveProducts();
    renderHistory();
  }
}
function updateAnalyticsBar() {
  const bar = document.getElementById("analyticsBar");
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const counts = {
    hoje: 0,
    "3d": 0,
    "7d": 0,
    "1m": 0,
    total: 0
  };

  products.forEach(p => {
    const vencimento = new Date(p.date + 'T00:00:00');
    const diffDays = (vencimento - today) / (1000 * 60 * 60 * 24);

    // Ignora vencidos e excluídos
    if (diffDays < 0 || p.excluido || p.vencido) return;

    // Conta total válido
    counts.total++;

    if (diffDays === 0) counts.hoje++;
    if (diffDays <= 3) counts["3d"]++;
    if (diffDays <= 7) counts["7d"]++;
    if (diffDays <= 30) counts["1m"]++;
  });

  const dataAtual = today.toLocaleDateString("pt-BR").slice(0, 5); // Tipo "02/04"
  bar.innerHTML = `
  <span>${dataAtual}: ${counts.hoje}</span>
  <span>3D: ${counts["3d"]}</span>
  <span>7D: ${counts["7d"]}</span>
  <span>1M: ${counts["1m"]}</span>
  <span>ALL: ${counts.total}</span>
`;
}
</script>
<!-- Tabela com jsPDF precisa da lib autoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</body>
</html>